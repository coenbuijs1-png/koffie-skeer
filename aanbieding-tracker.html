<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SKEER — Koffiecups in de aanbieding</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/*
  SKEER — HEMA-stijl design
  Wit, rood, zwart. Strak. Geen poespas.
*/

:root {
  --rood:       #e3191c;
  --rood-hover: #c51518;
  --rood-licht: #fdf0f0;
  --zwart:      #1a1a1a;
  --donker:     #2d2d2d;
  --grijs:      #f4f4f4;
  --grijs2:     #e8e8e8;
  --grijs3:     #b0b0b0;
  --grijs4:     #6b6b6b;
  --wit:        #ffffff;
  --groen:      #1a7f3c;
  --groen-licht:#e8f5ed;
  --oranje:     #e06b00;
  --border:     #e0e0e0;

  /* supermarkt kleuren */
  --ah:   #0065d1;
  --jumbo:#e6a800;
  --lidl: #0050aa;
  --aldi: #00458f;
  --plus: #c8001e;
  --dirk: #c01428;
  --hema: #e3191c;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html { font-size: 15px; }

body {
  background: var(--wit);
  color: var(--zwart);
  font-family: 'Inter', -apple-system, Arial, sans-serif;
  font-size: 1rem;
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
  min-height: 100vh;
}

a { color: inherit; }

/* ─── HEADER ──────────────────────────────────────────────── */
.skeer-header {
  background: var(--wit);
  border-bottom: 2px solid var(--zwart);
  position: sticky;
  top: 0;
  z-index: 200;
}

.skeer-header-inner {
  max-width: 1320px;
  margin: 0 auto;
  padding: 0 1.5rem;
  height: 60px;
  display: flex;
  align-items: center;
  gap: 2rem;
}

/* SKEER logo — rood, vet, geen gedoe */
.skeer-logo {
  font-size: 1.65rem;
  font-weight: 900;
  letter-spacing: -0.04em;
  color: var(--rood);
  line-height: 1;
  text-transform: uppercase;
  flex-shrink: 0;
  user-select: none;
}

.skeer-tagline {
  font-size: 0.78rem;
  color: var(--grijs4);
  font-weight: 400;
  letter-spacing: 0.01em;
  border-left: 1px solid var(--grijs2);
  padding-left: 1.5rem;
  line-height: 1.3;
  flex-shrink: 0;
}

.skeer-header-right {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-left: auto;
}

.skeer-update {
  font-size: 0.75rem;
  color: var(--grijs4);
  white-space: nowrap;
}

/* knop */
.skeer-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.45rem 1.1rem;
  background: var(--zwart);
  color: var(--wit);
  font-family: 'Inter', Arial, sans-serif;
  font-size: 0.8rem;
  font-weight: 700;
  letter-spacing: 0.02em;
  text-transform: uppercase;
  border: 2px solid var(--zwart);
  border-radius: 0;
  cursor: pointer;
  transition: background 0.12s, color 0.12s;
  text-decoration: none;
  white-space: nowrap;
}
.skeer-btn:hover { background: var(--rood); border-color: var(--rood); }
.skeer-btn:disabled { opacity: 0.45; cursor: not-allowed; }
.skeer-btn:disabled:hover { background: var(--zwart); border-color: var(--zwart); }

.spin-icon { display: inline-block; }
.spinning .spin-icon { animation: spin 0.7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ─── PAGE TITLE STRIP ──────────────────────────────────────── */
.skeer-title-strip {
  background: var(--rood);
  color: var(--wit);
  padding: 1.2rem 1.5rem;
}
.skeer-title-strip-inner {
  max-width: 1320px;
  margin: 0 auto;
  display: flex;
  align-items: baseline;
  gap: 1rem;
  flex-wrap: wrap;
}
.skeer-title-strip h1 {
  font-size: 1.5rem;
  font-weight: 800;
  letter-spacing: -0.02em;
  line-height: 1.1;
  text-transform: uppercase;
}
.skeer-title-strip-sub {
  font-size: 0.82rem;
  opacity: 0.82;
  font-weight: 400;
}

/* ─── BODY LAYOUT ───────────────────────────────────────────── */
.skeer-layout {
  max-width: 1320px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
  display: grid;
  grid-template-columns: 228px 1fr;
  gap: 2.5rem;
  align-items: start;
}

/* ─── SIDEBAR ───────────────────────────────────────────────── */
.skeer-sidebar {
  position: sticky;
  top: 72px;
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.skeer-filter-group {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.skeer-filter-title {
  font-size: 0.68rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--grijs4);
  margin-bottom: 0.6rem;
}

.skeer-filter-item {
  display: flex;
  align-items: center;
  gap: 0.55rem;
  padding: 0.55rem 0.5rem;
  font-size: 0.88rem;
  font-weight: 500;
  color: var(--grijs4);
  cursor: pointer;
  border-bottom: 1px solid var(--grijs);
  transition: color 0.1s;
  user-select: none;
}
.skeer-filter-item:first-of-type { border-top: 1px solid var(--grijs); }
.skeer-filter-item:hover { color: var(--zwart); }
.skeer-filter-item.active {
  color: var(--rood);
  font-weight: 700;
}
.skeer-filter-item.active .skeer-filter-dash {
  background: var(--rood);
}

.skeer-filter-dash {
  width: 12px;
  height: 2px;
  background: var(--grijs2);
  flex-shrink: 0;
  border-radius: 0;
}

.skeer-filter-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.skeer-filter-count {
  margin-left: auto;
  font-size: 0.73rem;
  color: var(--grijs3);
  font-weight: 600;
}
.skeer-filter-item.active .skeer-filter-count { color: var(--rood); }

/* bron status */
.skeer-bron-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.78rem;
  color: var(--grijs4);
  padding: 0.2rem 0;
}
.skeer-bron-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}

/* ─── MAIN CONTENT ──────────────────────────────────────────── */
.skeer-main { display: flex; flex-direction: column; gap: 1.5rem; }

/* ─── STATS ─────────────────────────────────────────────────── */
.skeer-stats {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0;
  border: 2px solid var(--zwart);
}

.skeer-stat {
  padding: 1rem 1.2rem;
  border-right: 2px solid var(--zwart);
  background: var(--wit);
}
.skeer-stat:last-child { border-right: none; }

.skeer-stat-label {
  font-size: 0.65rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--grijs4);
  margin-bottom: 0.25rem;
}
.skeer-stat-value {
  font-size: 2.2rem;
  font-weight: 900;
  letter-spacing: -0.03em;
  line-height: 1;
  color: var(--zwart);
}
.skeer-stat-value.rood   { color: var(--rood); }
.skeer-stat-value.groen  { color: var(--groen); }
.skeer-stat-sub {
  font-size: 0.72rem;
  color: var(--grijs3);
  margin-top: 0.2rem;
  font-weight: 400;
}

/* ─── TOOLBAR ───────────────────────────────────────────────── */
.skeer-toolbar {
  display: flex;
  align-items: center;
  gap: 1rem;
  border-bottom: 2px solid var(--zwart);
  padding-bottom: 0.75rem;
}

.skeer-count {
  font-size: 0.82rem;
  font-weight: 700;
  color: var(--grijs4);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.skeer-sort-wrap {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.skeer-sort-wrap label {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--grijs4);
  white-space: nowrap;
}
.skeer-select {
  background: var(--wit);
  border: 2px solid var(--zwart);
  color: var(--zwart);
  padding: 0.35rem 0.7rem;
  font-family: 'Inter', Arial, sans-serif;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  outline: none;
  border-radius: 0;
  appearance: auto;
}
.skeer-select:focus { border-color: var(--rood); }

/* ─── DEALS GRID ─────────────────────────────────────────────── */
.skeer-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(272px, 1fr));
  gap: 1px;
  background: var(--border);
  border: 2px solid var(--zwart);
}

/* ─── DEAL CARD ──────────────────────────────────────────────── */
.skeer-card {
  background: var(--wit);
  display: flex;
  flex-direction: column;
  animation: fadein 0.2s ease forwards;
  opacity: 0;
  position: relative;
  transition: box-shadow 0.15s;
}
.skeer-card:hover {
  box-shadow: inset 0 0 0 2px var(--zwart);
  z-index: 1;
}
@keyframes fadein { to { opacity: 1; } }

/* placeholder iets zachter */
.skeer-card.placeholder {
  animation: fadein-dim 0.2s ease forwards;
}
@keyframes fadein-dim { to { opacity: 0.65; } }
.skeer-card.placeholder:hover {
  opacity: 1;
  box-shadow: inset 0 0 0 2px var(--grijs3);
}

/* gekleurde top-lijn per supermarkt */
.skeer-card-top {
  height: 3px;
  width: 100%;
  flex-shrink: 0;
}

.skeer-card-body {
  padding: 1rem 1.1rem 0.8rem;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

.skeer-card-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.4rem;
}

/* supermarkt badge */
.skeer-badge {
  font-size: 0.6rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  padding: 0.18rem 0.5rem;
  border: 1.5px solid currentColor;
  white-space: nowrap;
  border-radius: 0;
}
.badge-ah    { color: #0052a8; }
.badge-jumbo { color: #9a6e00; }
.badge-lidl  { color: #003f88; }
.badge-aldi  { color: #003a78; }
.badge-plus  { color: #980017; }
.badge-dirk  { color: #8f0f1a; }
.badge-hema  { color: #c01216; }

/* live / folder tag */
.skeer-live-dot {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.62rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--groen);
}
.skeer-live-dot::before {
  content: '';
  width: 5px; height: 5px;
  border-radius: 50%;
  background: var(--groen);
  flex-shrink: 0;
}
.skeer-folder-dot {
  font-size: 0.62rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--grijs3);
}

/* productnaam */
.skeer-card-name {
  font-size: 0.95rem;
  font-weight: 700;
  line-height: 1.25;
  color: var(--zwart);
  margin-top: 0.15rem;
}

/* variant/hoeveelheid */
.skeer-card-variant {
  font-size: 0.78rem;
  color: var(--grijs4);
  line-height: 1.4;
}

/* prijs blok */
.skeer-card-price {
  display: flex;
  align-items: baseline;
  gap: 0.5rem;
  margin-top: 0.55rem;
  flex-wrap: wrap;
}
.skeer-price-now {
  font-size: 1.8rem;
  font-weight: 900;
  letter-spacing: -0.04em;
  color: var(--rood);
  line-height: 1;
}
.skeer-price-was {
  font-size: 0.85rem;
  color: var(--grijs3);
  text-decoration: line-through;
  font-weight: 400;
}
.skeer-discount-tag {
  background: var(--rood);
  color: var(--wit);
  font-size: 0.7rem;
  font-weight: 800;
  padding: 0.15rem 0.45rem;
  letter-spacing: 0.04em;
  margin-left: auto;
  align-self: center;
  border-radius: 0;
}

/* promo tekst */
.skeer-card-promo {
  font-size: 0.78rem;
  font-weight: 600;
  color: var(--oranje);
  margin-top: 0.15rem;
}

/* ─── CARD FOOTER ────────────────────────────────────────────── */
.skeer-card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  padding: 0.65rem 1.1rem;
  border-top: 1px solid var(--grijs);
  margin-top: auto;
  background: var(--grijs);
}

.skeer-validity {
  font-size: 0.72rem;
  color: var(--grijs4);
  font-weight: 500;
}
.skeer-validity.urgent { color: var(--rood); font-weight: 700; }
.skeer-validity.soon   { color: var(--oranje); font-weight: 600; }

/* link knop per card */
.skeer-card-link {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  background: var(--zwart);
  color: var(--wit);
  padding: 0.38rem 0.85rem;
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  text-decoration: none;
  white-space: nowrap;
  border-radius: 0;
  transition: background 0.12s;
}
.skeer-card-link:hover { background: var(--rood); }

/* ─── LEEG / LADEN ───────────────────────────────────────────── */
.skeer-loading {
  grid-column: 1/-1;
  padding: 4rem 2rem;
  text-align: center;
  color: var(--grijs4);
}
.skeer-spinner {
  font-size: 2rem;
  display: inline-block;
  animation: spin 1s linear infinite;
  margin-bottom: 0.75rem;
}
.skeer-empty {
  grid-column: 1/-1;
  padding: 4rem 2rem;
  text-align: center;
  color: var(--grijs3);
}
.skeer-empty .icon { font-size: 2rem; margin-bottom: 0.5rem; }
.skeer-empty p { font-size: 0.88rem; }

/* ─── BRONNEN PANEL ──────────────────────────────────────────── */
.skeer-bronnen {
  border: 2px solid var(--zwart);
  margin-top: 0.5rem;
}
.skeer-bronnen-header {
  background: var(--zwart);
  color: var(--wit);
  padding: 0.6rem 1rem;
  font-size: 0.7rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.12em;
}
.skeer-bronnen-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0;
}
.skeer-bron-card {
  padding: 1rem;
  border-right: 2px solid var(--zwart);
  background: var(--grijs);
}
.skeer-bron-card:last-child { border-right: none; }
.skeer-bron-card h3 {
  font-size: 0.8rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  margin-bottom: 0.4rem;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  flex-wrap: wrap;
}
.skeer-chip {
  font-size: 0.6rem;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  padding: 0.1rem 0.4rem;
  border: 1.5px solid currentColor;
}
.chip-live   { color: var(--groen); }
.chip-folder { color: var(--oranje); }
.chip-error  { color: var(--rood); }
.skeer-bron-card p {
  font-size: 0.77rem;
  color: var(--grijs4);
  line-height: 1.55;
}
.skeer-bron-card code {
  font-family: 'Courier New', monospace;
  font-size: 0.71rem;
  background: var(--wit);
  border: 1px solid var(--border);
  padding: 0.1rem 0.3rem;
  color: var(--donker);
}

/* ─── TOAST ──────────────────────────────────────────────────── */
.skeer-toast {
  position: fixed;
  bottom: 1.5rem;
  right: 1.5rem;
  background: var(--zwart);
  color: var(--wit);
  padding: 0.75rem 1.1rem;
  font-size: 0.82rem;
  font-weight: 600;
  letter-spacing: 0.01em;
  transform: translateY(80px);
  opacity: 0;
  transition: all 0.25s;
  z-index: 999;
  max-width: 360px;
  border-left: 4px solid var(--rood);
}
.skeer-toast.show { transform: translateY(0); opacity: 1; }

/* ─── SCROLLBAR ──────────────────────────────────────────────── */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: var(--grijs); }
::-webkit-scrollbar-thumb { background: var(--grijs2); border-radius: 0; }
::-webkit-scrollbar-thumb:hover { background: var(--grijs3); }

/* ─── RESPONSIVE ─────────────────────────────────────────────── */
@media (max-width: 1024px) {
  .skeer-layout { grid-template-columns: 200px 1fr; gap: 1.5rem; }
  .skeer-stats  { grid-template-columns: repeat(2, 1fr); }
  .skeer-stat:nth-child(2) { border-right: none; }
  .skeer-stat:nth-child(3) { border-top: 2px solid var(--zwart); }
  .skeer-stat:nth-child(4) { border-top: 2px solid var(--zwart); border-right: none; }
}
@media (max-width: 768px) {
  .skeer-layout     { grid-template-columns: 1fr; padding: 1rem; }
  .skeer-sidebar    { position: static; }
  .skeer-tagline    { display: none; }
  .skeer-bronnen-grid { grid-template-columns: 1fr; }
  .skeer-bron-card  { border-right: none; border-bottom: 2px solid var(--zwart); }
  .skeer-bron-card:last-child { border-bottom: none; }
  .skeer-stats      { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<!-- ─── HEADER ──────────────────────────────────────────────── -->
<header class="skeer-header">
  <div class="skeer-header-inner">
    <div class="skeer-logo" aria-label="SKEER">SKEER</div>
    <div class="skeer-tagline">Koffiecups in de aanbieding<br>bij Nederlandse supermarkten</div>
    <div class="skeer-header-right">
      <span class="skeer-update" id="updateTime"></span>
      <button class="skeer-btn refresh-btn" onclick="refreshAllData(true)" aria-label="Aanbiedingen verversen">
        <span class="spin-icon" aria-hidden="true">↻</span> Verversen
      </button>
    </div>
  </div>
</header>

<!-- ─── TITLE STRIP ──────────────────────────────────────────── -->
<div class="skeer-title-strip">
  <div class="skeer-title-strip-inner">
    <h1>Koffiecups aanbiedingen</h1>
    <span class="skeer-title-strip-sub">Live bijgehouden — dagelijks ververst</span>
  </div>
</div>

<!-- ─── LAYOUT ───────────────────────────────────────────────── -->
<div class="skeer-layout">

  <!-- SIDEBAR -->
  <aside aria-label="Filters">
    <div class="skeer-sidebar">

      <div class="skeer-filter-group">
        <div class="skeer-filter-title">Supermarkt</div>
        <div class="skeer-filter-item active" data-filter="supermarket" data-value="all"
             onclick="setFilter('supermarket','all',this)" tabindex="0" role="button">
          <span class="skeer-filter-dash"></span> Alle supermarkten
          <span class="skeer-filter-count" id="count-all">—</span>
        </div>
        <div class="skeer-filter-item" data-filter="supermarket" data-value="ah"
             onclick="setFilter('supermarket','ah',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--ah)"></span> Albert Heijn
          <span class="skeer-filter-count" id="count-ah">—</span>
        </div>
        <div class="skeer-filter-item" data-filter="supermarket" data-value="jumbo"
             onclick="setFilter('supermarket','jumbo',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--jumbo)"></span> Jumbo
          <span class="skeer-filter-count" id="count-jumbo">—</span>
        </div>
        <div class="skeer-filter-item" data-filter="supermarket" data-value="lidl"
             onclick="setFilter('supermarket','lidl',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--lidl)"></span> Lidl
          <span class="skeer-filter-count" id="count-lidl">—</span>
        </div>
        <div class="skeer-filter-item" data-filter="supermarket" data-value="aldi"
             onclick="setFilter('supermarket','aldi',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--aldi)"></span> Aldi
          <span class="skeer-filter-count" id="count-aldi">—</span>
        </div>
        <div class="skeer-filter-item" data-filter="supermarket" data-value="plus"
             onclick="setFilter('supermarket','plus',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--plus)"></span> Plus
          <span class="skeer-filter-count" id="count-plus">—</span>
        </div>
        <div class="skeer-filter-item" data-filter="supermarket" data-value="dirk"
             onclick="setFilter('supermarket','dirk',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--dirk)"></span> Dirk
          <span class="skeer-filter-count" id="count-dirk">—</span>
        </div>
        <div class="skeer-filter-item" data-filter="supermarket" data-value="hema"
             onclick="setFilter('supermarket','hema',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--hema)"></span> HEMA
          <span class="skeer-filter-count" id="count-hema">—</span>
        </div>
      </div>

      <div class="skeer-filter-group">
        <div class="skeer-filter-title">Korting</div>
        <div class="skeer-filter-item active" data-filter="discount" data-value="all"
             onclick="setFilter('discount','all',this)" tabindex="0" role="button">
          <span class="skeer-filter-dash"></span> Alle kortingen
        </div>
        <div class="skeer-filter-item" data-filter="discount" data-value="high"
             onclick="setFilter('discount','high',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--groen)"></span> Meer dan 30%
        </div>
        <div class="skeer-filter-item" data-filter="discount" data-value="medium"
             onclick="setFilter('discount','medium',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--oranje)"></span> 20 – 30%
        </div>
        <div class="skeer-filter-item" data-filter="discount" data-value="expires"
             onclick="setFilter('discount','expires',this)" tabindex="0" role="button">
          <span class="skeer-filter-dot" style="background:var(--rood)"></span> Verloopt binnenkort
        </div>
      </div>

      <div class="skeer-filter-group">
        <div class="skeer-filter-title">Databronnen</div>
        <div id="sourceStatus">
          <div class="skeer-bron-item">
            <span class="skeer-bron-dot" style="background:var(--grijs2)"></span>
            <span>Laden...</span>
          </div>
        </div>
      </div>

    </div>
  </aside>

  <!-- MAIN -->
  <main>
    <div class="skeer-main">

      <!-- STATS -->
      <div class="skeer-stats">
        <div class="skeer-stat">
          <div class="skeer-stat-label">Live deals</div>
          <div class="skeer-stat-value rood" id="stat-total">—</div>
          <div class="skeer-stat-sub">AH + Jumbo + HEMA + Aldi</div>
        </div>
        <div class="skeer-stat">
          <div class="skeer-stat-label">Koffiecups</div>
          <div class="skeer-stat-value" id="stat-coffee">—</div>
          <div class="skeer-stat-sub">Nu in aanbieding</div>
        </div>
        <div class="skeer-stat">
          <div class="skeer-stat-label">Beste korting</div>
          <div class="skeer-stat-value groen" id="stat-best">—</div>
          <div class="skeer-stat-sub" id="stat-best-sub">—</div>
        </div>
        <div class="skeer-stat">
          <div class="skeer-stat-label">Cache</div>
          <div class="skeer-stat-value" id="stat-cache" style="font-size:1.1rem;padding-top:0.5rem">—</div>
          <div class="skeer-stat-sub" id="stat-cache-sub">—</div>
        </div>
      </div>

      <!-- TOOLBAR -->
      <div class="skeer-toolbar">
        <span class="skeer-count" id="viewCount" aria-live="polite"></span>
        <div class="skeer-sort-wrap">
          <label for="sortSelect">Sorteren:</label>
          <select class="skeer-select" id="sortSelect" onchange="renderDeals()">
            <option value="discount">Beste korting eerst</option>
            <option value="price">Laagste prijs eerst</option>
            <option value="expires">Verloopt binnenkort</option>
            <option value="supermarket">Op supermarkt</option>
          </select>
        </div>
      </div>

      <!-- DEAL GRID -->
      <div class="skeer-grid" id="dealsGrid" role="list">
        <div class="skeer-loading">
          <div class="skeer-spinner" aria-hidden="true">⟳</div>
          <p>Aanbiedingen worden opgehaald...</p>
        </div>
      </div>

      <!-- BRONNEN -->
      <div class="skeer-bronnen">
        <div class="skeer-bronnen-header">Databronnen</div>
        <div class="skeer-bronnen-grid">
          <div class="skeer-bron-card">
            <h3>Albert Heijn <span class="skeer-chip chip-live" id="ah-status-badge">● Live</span></h3>
            <p>Via de AH GraphQL API (<code>api.ah.nl/graphql</code>). Anoniem token, geen login. Zoekt op bonus-gefilterde koffiecups. Cache 24u.</p>
          </div>
          <div class="skeer-bron-card">
            <h3>Jumbo <span class="skeer-chip chip-live" id="jumbo-status-badge">● Live</span></h3>
            <p>Via de Jumbo Mobile API (<code>mobileapi.jumbo.com/v17</code>). Directe productlink via <code>detailUrl</code>. Fallback: zoekpagina op naam. Cache 24u.</p>
          </div>
          <div class="skeer-bron-card">
            <h3>HEMA &amp; Aldi <span class="skeer-chip chip-folder" style="color:var(--oranje)">● Handmatig</span></h3>
            <p>Actuele deals handmatig bijgehouden. HEMA: 3 voor €9,99 (feb 2026). Aldi: Barissimo vaste lage prijs. Lidl, Plus, Dirk: link naar productpagina.</p>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<div class="skeer-toast" id="toast" role="status" aria-live="polite"></div>

<script>
// ─── CONSTANTEN ──────────────────────────────────────────────
const PROXY_BASE     = 'https://corsproxy.io/?url=';
const CACHE_DEALS    = 24 * 60 * 60 * 1000;  // 24 uur
const CACHE_TOKEN    = 2  * 60 * 60 * 1000;  // 2 uur

const KOFFIE_KEYS = [
  'nespresso','dolce gusto','senseo','koffiecup','koffiecaps',
  'capsule','pads','lungo','ristretto','espresso cup','perla',
  'bellarom','expressi','vertuo','caffitaly',"l'or capsule",
  "l'or cup",'douwe egberts cup','jacobs cap','koffie pad'
];

const SUPERMARKT_KLEUREN = {
  ah:'#0065d1', jumbo:'#e6a800', lidl:'#0050aa',
  aldi:'#00458f', plus:'#c8001e', dirk:'#c01428', hema:'#e3191c'
};
const SUPERMARKT_LABELS = {
  ah:'Albert Heijn', jumbo:'Jumbo', lidl:'Lidl',
  aldi:'Aldi', plus:'Plus', dirk:'Dirk', hema:'HEMA'
};

/*
  VASTE DEALS — handmatig bijgehouden voor winkels zonder API
  Bijgewerkt: februari 2026

  HEMA: 3 voor €9,99 aanbieding (normaal €5,49/stuk), 20 stuks per pak
  Aldi: Barissimo huismerk — vaste lage prijs, geen wekelijkse aanbieding
  Lidl: Bellarom huismerk — prijs alleen in de winkel zichtbaar
  Plus/Dirk: Geen actieve aanbieding gevonden
*/
const VASTE_DEALS = [
  // ── HEMA — actuele aanbieding: 3 voor €9,99 ──────────────────
  {
    id: 'hema-lungo-ultimo',
    supermarket: 'hema',
    product: 'HEMA Koffiecups Lungo Ultimo',
    variant: '20 stuks · Nespresso compatibel · sterkte 7',
    priceNow: 3.33,
    priceWas: 5.49,
    promo: '3 voor €9,99',
    validUntil: null,
    url: 'https://www.hema.nl/eten-drinken/koffie/koffiecups/koffiecups-lungo-ultimo---20-stuks-17180015.html',
    urlLabel: 'Bekijk bij HEMA',
    source: 'vaste-deal'
  },
  {
    id: 'hema-espresso-forte',
    supermarket: 'hema',
    product: 'HEMA Koffiecups Extra Forte',
    variant: '20 stuks · Nespresso compatibel · sterkte 12',
    priceNow: 3.33,
    priceWas: 5.49,
    promo: '3 voor €9,99',
    validUntil: null,
    url: 'https://www.hema.nl/eten-drinken/koffie/koffiecups/koffiecups-extra-forte---20-stuks-17180019.html',
    urlLabel: 'Bekijk bij HEMA',
    source: 'vaste-deal'
  },
  {
    id: 'hema-lungo-estremo',
    supermarket: 'hema',
    product: 'HEMA Koffiecups Lungo Estremo',
    variant: '20 stuks · Nespresso compatibel · sterkte 9',
    priceNow: 3.33,
    priceWas: 5.49,
    promo: '3 voor €9,99',
    validUntil: null,
    url: 'https://www.hema.nl/eten-drinken/koffie/koffiecups/koffiecups-lungo-estremo---20-stuks-17180053.html',
    urlLabel: 'Bekijk bij HEMA',
    source: 'vaste-deal'
  },
  {
    id: 'hema-ristretto',
    supermarket: 'hema',
    product: 'HEMA Koffiecups Ristretto',
    variant: '20 stuks · Nespresso compatibel · sterkte 10',
    priceNow: 3.33,
    priceWas: 5.49,
    promo: '3 voor €9,99',
    validUntil: null,
    url: 'https://www.hema.nl/eten-drinken/koffie/koffiecups/koffiecups-ristretto---20-stuks-17180018.html',
    urlLabel: 'Bekijk bij HEMA',
    source: 'vaste-deal'
  },
  {
    id: 'hema-espresso-classic',
    supermarket: 'hema',
    product: 'HEMA Koffiecups Espresso Classic',
    variant: '20 stuks · Nespresso compatibel · sterkte 8',
    priceNow: 3.33,
    priceWas: 5.49,
    promo: '3 voor €9,99',
    validUntil: null,
    url: 'https://www.hema.nl/eten-drinken/koffie/koffiecups/koffiecups-espresso-classic---20-stuks-17180014.html',
    urlLabel: 'Bekijk bij HEMA',
    source: 'vaste-deal'
  },
  {
    id: 'hema-decaf',
    supermarket: 'hema',
    product: 'HEMA Koffiecups Decaf',
    variant: '20 stuks · Nespresso compatibel · cafeïnevrij',
    priceNow: 3.33,
    priceWas: 5.49,
    promo: '3 voor €9,99',
    validUntil: null,
    url: 'https://www.hema.nl/eten-drinken/koffie/koffiecups/koffiecups-decaf---20-stuks-17180013.html',
    urlLabel: 'Bekijk bij HEMA',
    source: 'vaste-deal'
  },
  // ── ALDI — Barissimo huismerk, vaste lage prijzen ─────────────
  {
    id: 'aldi-lungo-classic',
    supermarket: 'aldi',
    product: 'Barissimo Koffiecups Lungo Classic',
    variant: '20 stuks · Nespresso compatibel',
    priceNow: 4.39,
    priceWas: null,
    promo: 'Elke dag lage prijs',
    validUntil: null,
    url: 'https://www.aldi.nl/product/koffiecups-lungo-classic-1227133.html',
    urlLabel: 'Bekijk bij Aldi',
    source: 'vaste-deal'
  },
  {
    id: 'aldi-espresso-forte',
    supermarket: 'aldi',
    product: 'Barissimo Koffiecups Espresso Forte',
    variant: '20 stuks · Nespresso compatibel',
    priceNow: 4.39,
    priceWas: null,
    promo: 'Elke dag lage prijs',
    validUntil: null,
    url: 'https://www.aldi.nl/product/koffiecups-espresso-forte-1227137.html',
    urlLabel: 'Bekijk bij Aldi',
    source: 'vaste-deal'
  },
  {
    id: 'aldi-lungo-extra-strong',
    supermarket: 'aldi',
    product: 'Barissimo Koffiecups Lungo Extra Strong',
    variant: '20 stuks · Nespresso compatibel',
    priceNow: 3.99,
    priceWas: null,
    promo: 'Elke dag lage prijs',
    validUntil: null,
    url: 'https://www.aldi.nl/product/koffiecups-lungo-extra-strong-1227136.html',
    urlLabel: 'Bekijk bij Aldi',
    source: 'vaste-deal'
  },
  {
    id: 'aldi-ristretto',
    supermarket: 'aldi',
    product: 'Barissimo Koffiecups Ristretto',
    variant: '20 stuks · Nespresso compatibel',
    priceNow: 4.39,
    priceWas: null,
    promo: 'Elke dag lage prijs',
    validUntil: null,
    url: 'https://www.aldi.nl/product/koffiecups-ristretto-1227132.html',
    urlLabel: 'Bekijk bij Aldi',
    source: 'vaste-deal'
  },
];

/*
  PLACEHOLDER STORES — winkels zonder API én zonder bekende actuele aanbieding
  Linken naar de juiste productcategorie.
*/
const PLACEHOLDER_STORES = [
  {
    supermarket: 'lidl',
    product: 'Bellarom Koffiecups bij Lidl',
    variant: 'Forte Lungo, Espresso e.a. · 20 stuks · Nespresso compatibel · prijs in de winkel',
    url: 'https://www.lidl.nl/p/bellarom-koffiecups-forte-lungo/p10000288',
    urlLabel: 'Bekijk bij Lidl',
    promo: 'Prijs beschikbaar in de winkel'
  },
  {
    supermarket: 'plus',
    product: 'Koffiecups bij Plus',
    variant: 'Bekijk het actuele koffie-aanbod',
    url: 'https://www.plus.nl/aanbiedingen/koffie-aanbiedingen',
    urlLabel: 'Bekijk bij Plus',
    promo: 'Bekijk actuele aanbiedingen'
  },
  {
    supermarket: 'dirk',
    product: 'Koffiecups bij Dirk',
    variant: '1 de Beste, Nescafé Dolce Gusto e.a.',
    url: 'https://www.dirk.nl/boodschappen/dranken-sap-koffie-thee/koffie-cacao',
    urlLabel: 'Bekijk bij Dirk',
    promo: 'Bekijk actuele aanbiedingen'
  },
];

// AH GraphQL query
const AH_QUERY = `
  query SearchProducts($input: ProductSearchInput) {
    products(input: $input) {
      result {
        id title quantity link
        brand { name }
        price { now was }
        discount { bonusType endDate promotionType theme }
      }
    }
  }
`;

// ─── CACHE ───────────────────────────────────────────────────
function cSave(key, data) {
  try { localStorage.setItem(key, JSON.stringify({ data, ts: Date.now() })); } catch(e) {}
}
function cLoad(key, ttl) {
  try {
    const r = localStorage.getItem(key);
    if (!r) return null;
    const { data, ts } = JSON.parse(r);
    return Date.now() - ts > ttl ? null : data;
  } catch(e) { return null; }
}
function cNieuweDag() {
  try {
    const r = localStorage.getItem('cache_ah');
    if (!r) return true;
    return new Date(JSON.parse(r).ts).toDateString() !== new Date().toDateString();
  } catch(e) { return true; }
}
function cLeeftijd() {
  try {
    const r = localStorage.getItem('cache_ah');
    if (!r) return null;
    const min = Math.round((Date.now() - JSON.parse(r).ts) / 60000);
    return min < 60 ? `${min} min geleden` : `${Math.round(min/60)} uur geleden`;
  } catch(e) { return null; }
}

// ─── AH API ──────────────────────────────────────────────────
async function ahToken() {
  const c = cLoad('cache_ah_token', CACHE_TOKEN);
  if (c) return c;
  const r = await fetch(PROXY_BASE + encodeURIComponent('https://api.ah.nl/mobile-auth/v1/auth/token/anonymous'), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ clientId: 'appie' })
  });
  if (!r.ok) throw new Error('AH token: ' + r.status);
  const { access_token } = await r.json();
  cSave('cache_ah_token', access_token);
  return access_token;
}

function isKoffie(title, brand) {
  const t = `${title||''} ${brand||''}`.toLowerCase();
  return KOFFIE_KEYS.some(k => t.includes(k));
}

async function ahDeals(token) {
  const terms = ['koffiecups', 'nespresso', 'dolce gusto', 'senseo'];
  const all = [];
  for (const q of terms) {
    try {
      const r = await fetch(PROXY_BASE + encodeURIComponent('https://api.ah.nl/graphql'), {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'x-application': 'AHWEBSHOP',
          'x-clientname': 'ah-shop',
        },
        body: JSON.stringify({
          query: AH_QUERY,
          variables: { input: { query: q, size: 30, page: 0, filters: [{ id: 'bonus', value: 'true' }] } }
        })
      });
      if (!r.ok) continue;
      const d = await r.json();
      all.push(...(d?.data?.products?.result || []));
    } catch(e) { console.warn('AH', q, e); }
  }
  const seen = new Set();
  return all
    .filter(p => p.discount && p.price?.was && p.price.now < p.price.was)
    .filter(p => isKoffie(p.title, p.brand?.name))
    .filter(p => !seen.has(p.id) && seen.add(p.id))
    .map(p => ({
      id: `ah-${p.id}`,
      supermarket: 'ah',
      product: p.title,
      variant: p.quantity || '',
      priceNow: +p.price.now,
      priceWas: +p.price.was,
      promo: p.discount?.theme || p.discount?.bonusType || 'Albert Heijn Bonus',
      validUntil: p.discount?.endDate || null,
      // AH: gebruik link veld als beschikbaar, anders directe zoekpagina op naam
      url: p.link
        ? `https://www.ah.nl${p.link}`
        : `https://www.ah.nl/zoeken?query=${encodeURIComponent(p.title)}&searchType=product`,
      urlLabel: 'Bekijk bij AH',
      source: 'ah-live'
    }));
}

async function ahFallback(token) {
  const all = [];
  for (const q of ['koffiecups', 'nespresso capsules', 'senseo pads']) {
    try {
      const r = await fetch(PROXY_BASE + encodeURIComponent(
        `https://api.ah.nl/mobile-services/product/search/v2?query=${encodeURIComponent(q)}&sortOn=RELEVANCE&size=30&bonus=true`
      ), { headers: { 'Authorization': `Bearer ${token}`, 'x-application': 'AHWEBSHOP' } });
      if (!r.ok) continue;
      const d = await r.json();
      all.push(...(d?.products || []));
    } catch(e) {}
  }
  const seen = new Set();
  return all
    .filter(p => p.price?.was && p.price.now < p.price.was)
    .filter(p => isKoffie(p.title, ''))
    .filter(p => !seen.has(p.id) && seen.add(p.id))
    .map(p => ({
      id: `ah-${p.id}`,
      supermarket: 'ah',
      product: p.title,
      variant: p.salesUnitSize || '',
      priceNow: +p.price.now,
      priceWas: +p.price.was,
      promo: p.discount?.description || 'Albert Heijn Bonus',
      validUntil: null,
      url: p.webPath
        ? `https://www.ah.nl${p.webPath}`
        : `https://www.ah.nl/zoeken?query=${encodeURIComponent(p.title)}&searchType=product`,
      urlLabel: 'Bekijk bij AH',
      source: 'ah-live'
    }));
}

// ─── JUMBO API ────────────────────────────────────────────────
async function jumboDeals() {
  const terms = ['koffiecups', 'nespresso capsules', 'senseo pads', 'dolce gusto'];
  const all = [];
  for (const q of terms) {
    try {
      const r = await fetch(PROXY_BASE + encodeURIComponent(
        `https://mobileapi.jumbo.com/v17/search?q=${encodeURIComponent(q)}&offset=0&limit=30`
      ), { headers: { 'User-Agent': 'Mozilla/5.0', 'Accept': 'application/json' } });
      if (!r.ok) continue;
      const d = await r.json();
      all.push(...(d?.products?.data || []));
    } catch(e) { console.warn('Jumbo', q, e); }
  }
  const seen = new Set();
  return all
    .filter(p => p.prices?.promotionalPrice?.amount !== undefined)
    .filter(p => isKoffie(p.title, ''))
    .filter(p => !seen.has(p.id) && seen.add(p.id))
    .map(p => {
      const priceNow = p.prices.promotionalPrice.amount / 100;
      const priceWas = p.prices.price.amount / 100;
      /*
        Jumbo URL strategie:
        De Jumbo website gebruikt: /producten/{naam-slug}-{ID}
        Slug = title in lowercase, spaties en speciale tekens naar koppelteken.
        Dit is de enige betrouwbare URL — de mobile API geeft geen detailUrl terug in v17.
      */
      const slug = p.title.toLowerCase()
        .replace(/['']/g, '-')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/-{2,}/g, '-')
        .replace(/^-|-$/g, '');
      const url = `https://www.jumbo.com/producten/${slug}-${p.id}`;
      return {
        id: `jumbo-${p.id}`,
        supermarket: 'jumbo',
        product: p.title,
        variant: p.quantity || '',
        priceNow,
        priceWas,
        promo: p.promotion?.text || 'Jumbo aanbieding',
        validUntil: p.promotion?.validUntilDate || null,
        url,
        urlLabel: 'Bekijk bij Jumbo',
        source: 'jumbo-live'
      };
    })
    .filter(p => p.priceNow < p.priceWas);
}

// ─── REFRESH ─────────────────────────────────────────────────
async function refreshAllData(force = false) {
  const btn = document.querySelector('.refresh-btn');
  btn.classList.add('spinning');
  btn.disabled = true;
  document.getElementById('dealsGrid').innerHTML =
    `<div class="skeer-loading"><div class="skeer-spinner">⟳</div><p>Aanbiedingen ophalen bij AH en Jumbo…</p></div>`;

  let ah = force ? null : cLoad('cache_ah', CACHE_DEALS);
  let jb = force ? null : cLoad('cache_jumbo', CACHE_DEALS);
  let ahErr = false, jbErr = false;
  const tasks = [];

  if (!ah) tasks.push(
    ahToken()
      .then(t => ahDeals(t))
      .then(d => d.length === 0 ? ahToken().then(t => ahFallback(t)) : d)
      .then(d => { ah = d; cSave('cache_ah', d); })
      .catch(e => { console.warn('AH mislukt:', e); ah = []; ahErr = true; })
  );
  if (!jb) tasks.push(
    jumboDeals()
      .then(d => { jb = d; cSave('cache_jumbo', d); })
      .catch(e => { console.warn('Jumbo mislukt:', e); jb = []; jbErr = true; })
  );

  await Promise.all(tasks);

  const placeholders = PLACEHOLDER_STORES.map((s, i) => ({
    ...s, id: `ph-${i}`, priceNow: null, priceWas: null, source: 'placeholder'
  }));
  state.deals = [...(ah||[]), ...(jb||[]), ...VASTE_DEALS, ...placeholders];

  updateStats();
  renderDeals();
  updateBronStatus(ah?.length||0, jb?.length||0, ahErr, jbErr);

  const tijd = new Date().toLocaleString('nl-NL', { hour:'2-digit', minute:'2-digit', day:'numeric', month:'short' });
  document.getElementById('updateTime').textContent = `Bijgewerkt: ${tijd}`;

  const n = (ah?.length||0) + (jb?.length||0);
  if (ahErr && jbErr)  showToast('⚠ Beide bronnen niet bereikbaar. Controleer je verbinding.');
  else if (ahErr)      showToast(`⚠ AH niet bereikbaar. ${jb?.length||0} Jumbo deals geladen.`);
  else if (jbErr)      showToast(`⚠ Jumbo niet bereikbaar. ${ah?.length||0} AH deals geladen.`);
  else                 showToast(`✓ ${ah?.length||0} AH + ${jb?.length||0} Jumbo deals geladen`);

  btn.classList.remove('spinning');
  btn.disabled = false;
}

function updateBronStatus(ahN, jbN, ahErr, jbErr) {
  const ahK  = ahErr  ? '#e3191c' : ahN  > 0 ? '#1a7f3c' : '#e06b00';
  const jbK  = jbErr  ? '#e3191c' : jbN  > 0 ? '#1a7f3c' : '#e06b00';
  document.getElementById('sourceStatus').innerHTML = `
    <div class="skeer-bron-item">
      <span class="skeer-bron-dot" style="background:${ahK}"></span>
      <span>AH: ${ahErr ? 'niet bereikbaar' : ahN + ' live deals'}</span>
    </div>
    <div class="skeer-bron-item">
      <span class="skeer-bron-dot" style="background:${jbK}"></span>
      <span>Jumbo: ${jbErr ? 'niet bereikbaar' : jbN + ' live deals'}</span>
    </div>
    <div class="skeer-bron-item">
      <span class="skeer-bron-dot" style="background:#e06b00"></span>
      <span>HEMA: 6 deals (3 voor €9,99)</span>
    </div>
    <div class="skeer-bron-item">
      <span class="skeer-bron-dot" style="background:#e06b00"></span>
      <span>Aldi: 4 deals (Barissimo)</span>
    </div>
    <div class="skeer-bron-item">
      <span class="skeer-bron-dot" style="background:var(--grijs3)"></span>
      <span>Lidl/Plus/Dirk: link naar winkel</span>
    </div>`;

  const ahB = document.getElementById('ah-status-badge');
  const jbB = document.getElementById('jumbo-status-badge');
  if (ahB) { ahB.className = `skeer-chip ${ahErr?'chip-error':'chip-live'}`; ahB.textContent = ahErr ? '● Fout' : `● ${ahN} deals`; }
  if (jbB) { jbB.className = `skeer-chip ${jbErr?'chip-error':'chip-live'}`; jbB.textContent = jbErr ? '● Fout' : `● ${jbN} deals`; }
}

// ─── STATE & FILTERS ─────────────────────────────────────────
let state = { deals: [], activeSupermarket: 'all', activeDiscount: 'all' };

function korting(d) {
  if (!d.priceNow || !d.priceWas || d.priceWas === 0) return 0;
  return Math.round((1 - d.priceNow / d.priceWas) * 100);
}
function dagenOver(v) {
  if (!v) return null;
  const e = new Date(v);
  return isNaN(e) ? null : Math.ceil((e - new Date()) / 86400000);
}

function setFilter(type, value, el) {
  document.querySelectorAll(`[data-filter="${type}"]`).forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  if (type === 'supermarket') state.activeSupermarket = value;
  if (type === 'discount')    state.activeDiscount    = value;
  renderDeals();
}

function gefilterd() {
  let d = [...state.deals];
  if (state.activeSupermarket !== 'all') d = d.filter(x => x.supermarket === state.activeSupermarket);
  if (state.activeDiscount === 'high')   d = d.filter(x => x.source !== 'placeholder' && x.priceNow && korting(x) >= 30);
  if (state.activeDiscount === 'medium') d = d.filter(x => x.source !== 'placeholder' && x.priceNow && korting(x) >= 20 && korting(x) < 30);
  if (state.activeDiscount === 'expires') d = d.filter(x => {
    if (x.source === 'placeholder' || x.source === 'vaste-deal') return false;
    const dl = dagenOver(x.validUntil);
    return dl !== null && dl <= 3;
  });
  const s = document.getElementById('sortSelect')?.value || 'discount';
  if (s === 'discount')    d.sort((a, b) => korting(b) - korting(a));
  if (s === 'price')       d.sort((a, b) => (a.priceNow ?? 9999) - (b.priceNow ?? 9999));
  if (s === 'expires')     d.sort((a, b) => (dagenOver(a.validUntil) ?? 9999) - (dagenOver(b.validUntil) ?? 9999));
  if (s === 'supermarket') d.sort((a, b) => a.supermarket.localeCompare(b.supermarket));
  return d;
}

// ─── RENDER ──────────────────────────────────────────────────
function kaart(d, i) {
  const kleur = SUPERMARKT_KLEUREN[d.supermarket] || '#ccc';
  const label = SUPERMARKT_LABELS[d.supermarket]  || d.supermarket;
  const delay = `animation-delay:${i * 0.03}s`;

  if (d.source === 'placeholder') {
    return `
    <article class="skeer-card placeholder" style="${delay}" role="listitem">
      <div class="skeer-card-top" style="background:${kleur}"></div>
      <div class="skeer-card-body">
        <div class="skeer-card-meta">
          <span class="skeer-badge badge-${d.supermarket}">${label}</span>
          <span class="skeer-folder-dot">Bekijk online</span>
        </div>
        <div class="skeer-card-name">${d.product}</div>
        <div class="skeer-card-variant">${d.variant}</div>
        <div class="skeer-card-promo">${d.promo}</div>
      </div>
      <div class="skeer-card-footer">
        <span class="skeer-validity">Actuele prijs op de site</span>
        <a href="${d.url}" target="_blank" rel="noopener noreferrer"
           class="skeer-card-link">${d.urlLabel} ↗</a>
      </div>
    </article>`;
  }

  // Vaste deal (HEMA, Aldi) — toon prijs maar andere badge
  if (d.source === 'vaste-deal') {
    const pct = korting(d);
    return `
    <article class="skeer-card" style="${delay}" role="listitem">
      <div class="skeer-card-top" style="background:${kleur}"></div>
      <div class="skeer-card-body">
        <div class="skeer-card-meta">
          <span class="skeer-badge badge-${d.supermarket}">${label}</span>
          <span class="skeer-folder-dot" style="color:var(--oranje)">● Handmatig</span>
        </div>
        <div class="skeer-card-name">${d.product}</div>
        <div class="skeer-card-variant">${d.variant}</div>
        <div class="skeer-card-price">
          <span class="skeer-price-now">€${d.priceNow.toFixed(2)}</span>
          ${d.priceWas ? `<span class="skeer-price-was">€${d.priceWas.toFixed(2)}</span>` : ''}
          ${pct > 0 ? `<span class="skeer-discount-tag">−${pct}%</span>` : ''}
        </div>
        ${d.promo ? `<div class="skeer-card-promo">${d.promo}</div>` : ''}
      </div>
      <div class="skeer-card-footer">
        <span class="skeer-validity" style="color:var(--grijs3);font-size:0.68rem">Bijgewerkt feb 2026</span>
        <a href="${d.url}" target="_blank" rel="noopener noreferrer"
           class="skeer-card-link"
           aria-label="${d.urlLabel}: ${d.product}">${d.urlLabel} ↗</a>
      </div>
    </article>`;
  }

  const pct  = korting(d);
  const dl   = dagenOver(d.validUntil);
  const vCls = dl !== null ? (dl <= 1 ? 'urgent' : dl <= 3 ? 'soon' : '') : '';
  const vTxt = dl === null ? 'Geldigheid onbekend'
    : dl <= 0 ? 'Verlopen'
    : dl === 1 ? '⚠ Verloopt morgen'
    : `Geldig t/m ${d.validUntil}`;

  return `
  <article class="skeer-card" style="${delay}" role="listitem">
    <div class="skeer-card-top" style="background:${kleur}"></div>
    <div class="skeer-card-body">
      <div class="skeer-card-meta">
        <span class="skeer-badge badge-${d.supermarket}">${label}</span>
        <span class="skeer-live-dot">${d.source === 'ah-live' ? 'AH live' : 'Jumbo live'}</span>
      </div>
      <div class="skeer-card-name">${d.product}</div>
      <div class="skeer-card-variant">${d.variant}</div>
      <div class="skeer-card-price">
        <span class="skeer-price-now">€${d.priceNow.toFixed(2)}</span>
        <span class="skeer-price-was">€${d.priceWas.toFixed(2)}</span>
        ${pct > 0 ? `<span class="skeer-discount-tag">−${pct}%</span>` : ''}
      </div>
      ${d.promo ? `<div class="skeer-card-promo">${d.promo}</div>` : ''}
    </div>
    <div class="skeer-card-footer">
      <span class="skeer-validity ${vCls}">${vTxt}</span>
      <a href="${d.url}" target="_blank" rel="noopener noreferrer"
         class="skeer-card-link"
         aria-label="${d.urlLabel}: ${d.product}">${d.urlLabel} ↗</a>
    </div>
  </article>`;
}

function renderDeals() {
  const d = gefilterd();
  const g = document.getElementById('dealsGrid');
  document.getElementById('viewCount').textContent = `${d.length} aanbieding${d.length !== 1 ? 'en' : ''}`;
  if (d.length === 0) {
    g.innerHTML = `<div class="skeer-empty"><div class="icon">☕</div><p>Geen aanbiedingen met deze filters.</p></div>`;
    return;
  }
  g.innerHTML = d.map((x, i) => kaart(x, i)).join('');
}

function updateStats() {
  const all   = state.deals;
  const live  = all.filter(d => d.source !== 'placeholder');
  const metK  = live.filter(d => d.priceNow && korting(d) > 0);
  const beste = metK.length ? metK.reduce((m, d) => korting(d) > korting(m) ? d : m, metK[0]) : null;

  document.getElementById('stat-total').textContent  = live.length;
  document.getElementById('stat-coffee').textContent = live.length;

  if (beste) {
    document.getElementById('stat-best').textContent     = `−${korting(beste)}%`;
    document.getElementById('stat-best-sub').textContent = beste.product.length > 28 ? beste.product.slice(0,26)+'…' : beste.product;
  } else {
    document.getElementById('stat-best').textContent     = '—';
    document.getElementById('stat-best-sub').textContent = 'Geen korting gevonden';
  }

  const leeftijd = cLeeftijd();
  document.getElementById('stat-cache').textContent     = leeftijd ? '✓' : '—';
  document.getElementById('stat-cache-sub').textContent = leeftijd ? leeftijd : 'Geen cache';

  ['ah','jumbo','lidl','aldi','plus','dirk','hema'].forEach(s => {
    const el = document.getElementById(`count-${s}`);
    if (el) el.textContent = all.filter(d => d.supermarket === s).length || '0';
  });
  const ca = document.getElementById('count-all');
  if (ca) ca.textContent = all.length;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}

// ─── INIT ─────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', async () => {
  const cahAH    = cLoad('cache_ah',    CACHE_DEALS);
  const cahJumbo = cLoad('cache_jumbo', CACHE_DEALS);

  if (cahAH && cahJumbo && !cNieuweDag()) {
    const placeholders = PLACEHOLDER_STORES.map((s, i) => ({
      ...s, id: `ph-${i}`, priceNow: null, priceWas: null, source: 'placeholder'
    }));
    state.deals = [...cahAH, ...cahJumbo, ...VASTE_DEALS, ...placeholders];
    updateStats();
    renderDeals();
    updateBronStatus(cahAH.length, cahJumbo.length, false, false);
    const tijd = new Date().toLocaleString('nl-NL', { hour:'2-digit', minute:'2-digit', day:'numeric', month:'short' });
    document.getElementById('updateTime').textContent = `Cache — ${tijd}`;
    showToast(`✓ ${cahAH.length + cahJumbo.length} deals uit cache (${cLeeftijd()})`);
  } else {
    await refreshAllData(false);
  }
});
</script>
</body>
</html>
